<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Supabase Realtime â€” Multiplayer Dots (No DB)</title>
  <style>
    html,body{height:100%;margin:0;background:#0e1117;color:#e5e7eb;font-family:system-ui}
    .wrap{height:100%;display:flex;align-items:center;justify-content:center;padding:12px}
    canvas{background:#0b1522;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .hud{position:fixed;left:12px;bottom:12px;font-size:14px;opacity:.85}
    .chip{display:inline-block;padding:4px 8px;border-radius:999px;background:#172033;margin-right:6px}
  </style>
</head>
<body>
  <div class="wrap"><canvas id="c" width="900" height="600"></canvas></div>
  <div class="hud">
    <span class="chip">Players online: <span id="cnt">1</span></span>
    <span class="chip">You: <span id="me">?</span></span>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // ðŸ”§ Replace with your project values
    const SUPABASE_URL = "https://jlbpbizelvnrzadyztfz.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpsYnBiaXplbHZucnphZHl6dGZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg0MzgzMjEsImV4cCI6MjA3NDAxNDMyMX0.DgsIreHYbd6ynUIFlAk8U-j2i0W3qkT9hm41toFFBxI";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Identity
    const uid   = crypto.randomUUID();
    const name  = "guest" + Math.floor(Math.random()*9999);
    const color = `hsl(${Math.floor(Math.random()*360)},90%,65%)`;
    document.getElementById("me").textContent = name;

    // Canvas
    const cvs = document.getElementById("c");
    const ctx = cvs.getContext("2d");

    // Local state
    const me = { id: uid, name, color, x: 450, y: 300, vx:0, vy:0 };
    const others = new Map(); // id -> {id,name,color,x,y,ts}

    // Realtime channel (broadcast + presence)
    const room = supabase.channel("dots-room", {
      config: {
        broadcast: { self: false },   // donâ€™t echo my own broadcasts
        presence:  { key: uid }       // identify me in presence
      }
    });

    // Presence: whoâ€™s online
    room.on("presence", { event: "sync" }, () => {
      const state = room.presenceState(); // { [key]: [{userâ€¦}] }
      // Build online list from presence keys
      const onlineIds = Object.keys(state);
      document.getElementById("cnt").textContent = onlineIds.length;
    });

    // Presence: join with my user fields
    room.subscribe((status) => {
      console.log("channel status:", status);
      if (status === "SUBSCRIBED") {
        room.track({ id: uid, name, color });
      }
    });

    // Receive other players' position updates
    room.on("broadcast", { event: "state" }, (payload) => {
      const p = payload.payload;           // {id,name,color,x,y,ts}
      if (!p || p.id === uid) return;
      others.set(p.id, p);
    });

    // Controls
    const keys = new Set();
    addEventListener("keydown", e => {
      if (["ArrowUp","ArrowDown","ArrowLeft","ArrowRight","w","a","s","d"].includes(e.key)) {
        keys.add(e.key.toLowerCase()); e.preventDefault();
      }
    });
    addEventListener("keyup", e => keys.delete(e.key.toLowerCase()));

    // Game loop + broadcast ~10/sec
    let last = performance.now(), acc = 0;
    function loop(t){
      const dt = Math.min(0.05, (t - last) / 1000); last = t;
      const up = keys.has("arrowup")||keys.has("w");
      const dn = keys.has("arrowdown")||keys.has("s");
      const lf = keys.has("arrowleft")||keys.has("a");
      const rt = keys.has("arrowright")||keys.has("d");
      const speed = 240;

      me.x = Math.max(0, Math.min(cvs.width,  me.x + (rt - lf)*speed*dt));
      me.y = Math.max(0, Math.min(cvs.height, me.y + (dn - up)*speed*dt));

      acc += dt;
      if (acc > 0.1) {
        acc = 0;
        room.send({ type: "broadcast", event: "state", payload: { id: uid, name, color, x: Math.round(me.x), y: Math.round(me.y), ts: Date.now() }});
      }

      // draw
      ctx.clearRect(0,0,cvs.width,cvs.height);
      for (const p of others.values()) draw(p.x, p.y, p.color || "#fcd34d", p.name || "player");
      draw(me.x, me.y, color, name, true);

      requestAnimationFrame(loop);
    }
    requestAnimationFrame(loop);

    function draw(x,y,color,name,isMe=false){
      ctx.beginPath(); ctx.arc(x,y,8,0,Math.PI*2); ctx.fillStyle=color; ctx.fill();
      ctx.fillStyle="rgba(255,255,255,.9)"; ctx.font="12px system-ui"; ctx.textAlign="center";
      ctx.fillText(name, x, y - 14);
      if (isMe){ ctx.strokeStyle="rgba(255,255,255,.6)"; ctx.lineWidth=2; ctx.beginPath(); ctx.arc(x,y,12,0,Math.PI*2); ctx.stroke(); }
    }
  </script>
</body>
</html>
