<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Collaborative Python Editor</title>
  <style>
    :root { --bg:#0b1220; --ink:#e9eefc; --panel:#111827; --muted:#9aa4bf; }
    html, body { height:100%; margin:0; background:var(--bg); color:var(--ink); font-family:ui-sans-serif,system-ui; }
    .topbar {
      display:flex; gap:12px; align-items:center; padding:10px 12px; background:var(--panel);
      position:sticky; top:0; z-index:5; border-bottom:1px solid #1f2937;
    }
    .label { color:var(--muted); margin-right:6px; }
    .topbar input, .topbar button {
      background:#0f172a; color:var(--ink); border:1px solid #1f2937; border-radius:8px; padding:8px 10px;
    }
    .topbar button { cursor:pointer }
    .status { font-size:12px; color:var(--muted); }
    #editor { height: calc(100vh - 52px); width:100%; }
    #output {
      white-space:pre-wrap; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, "Courier New", monospace;
      background:#0f172a; padding:10px; border-top:1px solid #1f2937; max-height:40vh; overflow:auto;
    }
    .bottom { position:fixed; left:0; right:0; bottom:0; }
  </style>

  <!-- Monaco loader -->
  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.49.0/min/vs/loader.js"></script>

  <!-- Yjs + providers -->
  <script src="https://cdn.jsdelivr.net/npm/yjs@13.6.18/dist/yjs.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/y-webrtc@10.6.3/dist/y-webrtc.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/y-monaco@0.4.3/dist/y-monaco.js"></script>

  <!-- Pyodide (lazy-loaded) -->
  <script>
    const pyodideReady = (async () => {
      const s = document.createElement('script');
      s.src = "https://cdn.jsdelivr.net/pyodide/v0.26.2/full/pyodide.js";
      document.head.appendChild(s);
      await new Promise(r => s.onload = r);
      return await loadPyodide();
    })();
  </script>
</head>
<body>
  <div class="topbar">
    <span class="label">Room:</span>
    <input id="room" placeholder="room-id (same id = same file)" />
    <button id="connectBtn" disabled>Connect</button>
    <button id="runBtn" disabled>Run (Pyodide)</button>
    <span class="status" id="status">Room:</span>
    <span class="status" id="peers">peers: 0</span>
  </div>

  <div id="editor"></div>

  <div class="bottom" id="bottom" style="display:none;">
    <div id="output"></div>
  </div>

  <script>
    // ---------- CONFIG ----------
    // Change this if your file lives under a different folder.
    // Example desired URL: https://ites1f.github.io/ites1f/python/<room>
    const BASE_PATH = "/ites1f/python/"; // must start and end with "/"

    // Turn any user input into a safe path segment
    function slugifyRoom(str) {
      // trim, collapse spaces, replace with "-", drop illegal path chars
      return encodeURIComponent(
        str.trim()
           .replace(/\s+/g, "-")
           .replace(/[\/?#%]+/g, "-")
      );
    }

    function getRoomFromPath() {
      // Returns room from /ites1f/python/<room> (no trailing slash),
      // or from hash (#room) if present.
      const { pathname, hash } = location;

      // Prefer clean PATH room (pretty URL)
      if (pathname.startsWith(BASE_PATH)) {
        const tail = pathname.slice(BASE_PATH.length); // "<room>" or "" or "anything/else"
        if (tail && !tail.includes("/")) {
          try { return decodeURIComponent(tail); } catch { return tail; }
        }
      }
      // Fallback to hash-based
      if (hash && hash.length > 1) {
        try { return decodeURIComponent(hash.slice(1)); } catch { return hash.slice(1); }
      }
      return "";
    }

    function setPrettyURL(room) {
      // Update URL to /ites1f/python/<room> (no page reload)
      const pretty = BASE_PATH + slugifyRoom(room);
      history.replaceState(null, "", pretty);
    }

    // ---------- Monaco boot ----------
    let editor;
    const defaultCode = `# Collaborative Python file
# Share this URL to collaborate:
#   https://ites1f.github.io/ites1f/python/<room>
# Replace <room> with a name, or click Connect to set it.

def greet(name):
    return "Hello, " + name + "!"

print(greet("world"))
`;

    require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.49.0/min/vs' } });
    require(["vs/editor/editor.main"], function () {
      editor = monaco.editor.create(document.getElementById('editor'), {
        value: defaultCode,
        language: "python",
        theme: "vs-dark",
        automaticLayout: true,
        fontSize: 14,
        minimap: { enabled: true }
      });
      document.getElementById('connectBtn').disabled = false;
      document.getElementById('runBtn').disabled = false;

      // Auto-connect if URL encodes a room
      const roomFromURL = getRoomFromPath();
      if (roomFromURL) {
        document.getElementById('room').value = roomFromURL;
        connect(roomFromURL);
      }
    });

    // ---------- Collab (Yjs + y-webrtc) ----------
    let ydoc, provider, ytext, awareness, monacoBinding;

    function connect(room) {
      if (!room) { alert("Enter a room id"); return; }
      if (!editor) { alert("Editor not ready yet"); return; }

      // Clean previous session if any
      if (monacoBinding && monacoBinding.destroy) monacoBinding.destroy();
      if (provider) provider.destroy();

      ydoc = new Y.Doc();
      provider = new Y.WebrtcProvider(room, ydoc, {
        signaling: [
          'wss://signaling.yjs.dev',
          'wss://y-webrtc-signaling-eu.herokuapp.com',
          'wss://y-webrtc-signaling-us.herokuapp.com'
        ]
      });

      awareness = provider.awareness;

      // give yourself presence so peers count includes you
      const me = {
        name: "guest" + Math.floor(Math.random() * 9999),
        color: "#" + Math.floor(Math.random()*0xffffff).toString(16).padStart(6,"0")
      };
      awareness.setLocalState({ user: me });

      ytext = ydoc.getText("file.py");

      const MonacoBindingCtor =
        (window.yMonaco && window.yMonaco.MonacoBinding) ||
        (window.YMonaco && window.YMonaco.MonacoBinding);

      monacoBinding = new MonacoBindingCtor(
        ytext,
        editor.getModel(),
        new Set([editor]),
        awareness
      );

      if (ytext.length === 0) {
        ytext.insert(0, editor.getValue());
      } else {
        editor.setValue(ytext.toString());
      }

      // UI + pretty URL (/ites1f/python/<room>)
      document.getElementById('status').textContent = `Room: ${room}`;
      setPrettyURL(room);

      // Peers indicator
      const peersEl = document.getElementById('peers');
      const updatePeers = () => {
        peersEl.textContent = `peers: ${awareness.getStates().size}`;
      };
      awareness.on('update', updatePeers);
      provider.on('status', e => {
        document.getElementById('status').textContent =
          `Room: ${room} (${e.status})`;
      });
      updatePeers();
    }

    document.getElementById('connectBtn').addEventListener('click', () => {
      const room = document.getElementById('room').value.trim();
      connect(room);
    });

    // ---------- Run via Pyodide ----------
    const bottom = document.getElementById('bottom');
    const output = document.getElementById('output');
    function showOutput(text) {
      bottom.style.display = 'block';
      output.textContent = text;
    }

    document.getElementById('runBtn').addEventListener('click', async () => {
      showOutput("⏳ Loading Pyodide / running code...");
      try {
        const pyodide = await pyodideReady;
        let stdout = "";
        pyodide.setStdout({ batched: s => { stdout += s; } });
        pyodide.setStderr({ batched: s => { stdout += s; } });
        const code = editor.getValue();
        await pyodide.runPythonAsync(code);
        showOutput(stdout || "✅ Finished (no output)");
      } catch (err) {
        showOutput("❌ Error:\n" + (err?.message || String(err)));
      }
    });
  </script>
</body>
</html>
