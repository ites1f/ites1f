<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Collaborative Python Editor (Supabase)</title>
  <style>
    :root { --bg:#0b1220; --ink:#e9eefc; --panel:#111827; --muted:#9aa4bf; }
    html, body { height:100%; margin:0; background:var(--bg); color:var(--ink); font-family:ui-sans-serif,system-ui; }
    .topbar {
      display:flex; gap:12px; align-items:center; padding:10px 12px; background:var(--panel);
      position:sticky; top:0; z-index:5; border-bottom:1px solid #1f2937;
    }
    .label { color:var(--muted); margin-right:6px; }
    .topbar input, .topbar button {
      background:#0f172a; color:var(--ink); border:1px solid #1f2937; border-radius:8px; padding:8px 10px;
    }
    .topbar button { cursor:pointer }
    .status { font-size:12px; color:var(--muted); }
    #editor { height: calc(100vh - 52px); width:100%; }
    #output {
      white-space:pre-wrap; font-family:ui-monospace, Menlo, Monaco, "Courier New", monospace;
      background:#0f172a; padding:10px; border-top:1px solid #1f2937; max-height:40vh; overflow:auto;
    }
    .bottom { position:fixed; left:0; right:0; bottom:0; }
  </style>

  <!-- Monaco Editor -->
  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.49.0/min/vs/loader.js"></script>

  <!-- Supabase JS -->
  <script type="module" crossorigin src="https://esm.sh/@supabase/supabase-js@2"></script>

  <!-- Pyodide (Python in browser) -->
  <script>
    const pyodideReady = (async () => {
      const s = document.createElement('script');
      s.src = "https://cdn.jsdelivr.net/pyodide/v0.26.2/full/pyodide.js";
      document.head.appendChild(s);
      await new Promise(r => s.onload = r);
      return await loadPyodide();
    })();
  </script>
</head>
<body>
  <div class="topbar">
    <span class="label">Room:</span>
    <input id="room" placeholder="room-id (same id = same file)"/>
    <button id="connectBtn" disabled>Connect</button>
    <button id="runBtn" disabled>Run (Pyodide)</button>
    <span class="status" id="status">Room:</span>
    <span class="status" id="peers">peers: 0</span>
  </div>

  <div id="editor"></div>

  <div class="bottom" id="bottom" style="display:none;">
    <div id="output"></div>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // üö® Replace with your Supabase project details
    const SUPABASE_URL = "https://rcnpjkurmypvcwvpdaay.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJjbnBqa3VybXlwdmN3dnBkYWF5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4NzA5NjAsImV4cCI6MjA3NDQ0Njk2MH0.5FBoK6nQ0ojmGfr8yfj7jOGvMLij0yIxF-fmqMlDHuQ";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let editor;
    const defaultCode = `# Collaborative Python editor
# Type in here, share your room link, and edit together!
# Click Run to execute Python with Pyodide (in your browser).

def greet(name):
    return "Hello, " + name + "!"

print(greet("world"))
`;

    // Init Monaco
    require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.49.0/min/vs' } });
    require(["vs/editor/editor.main"], function () {
      editor = monaco.editor.create(document.getElementById('editor'), {
        value: defaultCode,
        language: "python",
        theme: "vs-dark",
        automaticLayout: true,
        fontSize: 14,
        minimap: { enabled: true }
      });
      document.getElementById('connectBtn').disabled = false;
      document.getElementById('runBtn').disabled = false;
    });

    // ----- Collaboration -----
    let channel = null;
    let clientId = crypto.randomUUID();
    let rev = 0, lastRemoteRev = 0;
    let suppressRemote = false;

    async function connect(room) {
      if (!room) { alert("Enter a room id"); return; }

      if (channel) await channel.unsubscribe();
      channel = supabase.channel(`python-${room}`, {
        config: { broadcast: { self:false }, presence: { key: clientId } }
      });

      // Presence
      const peersEl = document.getElementById('peers');
      channel.on("presence", { event: "sync" }, () => {
        const state = channel.presenceState();
        peersEl.textContent = `peers: ${Object.keys(state).length}`;
      });

      // Broadcast handler
      channel.on("broadcast", { event: "doc" }, ({ payload }) => {
        if (!payload || payload.from === clientId) return;
        if (payload.rev > lastRemoteRev) {
          lastRemoteRev = payload.rev;
          suppressRemote = true;
          const sel = editor.getSelection();
          editor.setValue(payload.doc);
          if (sel) editor.setSelection(sel);
          suppressRemote = false;
        }
      });

      await channel.subscribe((status) => {
        document.getElementById('status').textContent = `Room: ${room} (${status})`;
      });
      await channel.track({ user: { id: clientId, name: "guest" + Math.floor(Math.random()*9999) } });

      // Send updates on change
      editor.onDidChangeModelContent(() => {
        if (suppressRemote) return;
        rev += 1;
        channel.send({
          type: "broadcast",
          event: "doc",
          payload: { doc: editor.getValue(), rev, from: clientId }
        });
      });
    }

    document.getElementById('connectBtn').addEventListener('click', () => {
      connect(document.getElementById('room').value.trim());
    });

    // ----- Run Python -----
    const output = document.getElementById('output');
    const bottom = document.getElementById('bottom');
    function showOutput(text) {
      bottom.style.display = 'block';
      output.textContent = text;
    }
    document.getElementById('runBtn').addEventListener('click', async () => {
      showOutput("‚è≥ Running...");
      try {
        const pyodide = await pyodideReady;
        let stdout = "";
        pyodide.setStdout({ batched: s => stdout += s });
        pyodide.setStderr({ batched: s => stdout += s });
        await pyodide.runPythonAsync(editor.getValue());
        showOutput(stdout || "‚úÖ Finished (no output)");
      } catch (err) {
        showOutput("‚ùå Error:\n" + err.message);
      }
    });
  </script>
</body>
</html>
